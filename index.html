<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KBJU Tracker</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram WebApp API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS –¥–ª—è —Å—Ç–∏–ª—è -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, #3b82f6);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="p-4 pb-20">

    <!-- HEADER: –ü–†–û–ì–†–ï–°–° -->
    <div class="card p-5 mb-6 relative overflow-hidden">
        <h2 class="text-xl font-bold mb-4 text-center opacity-80">–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–µ–≥–æ–¥–Ω—è</h2>
        
        <div class="flex justify-center mb-4 relative h-40">
            <!-- –ö—Ä—É–≥–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ –ö–∞–ª–æ—Ä–∏–π -->
            <canvas id="caloriesChart"></canvas>
            <div class="absolute inset-0 flex items-center justify-center flex-col pt-4">
                <span id="calLeft" class="text-2xl font-bold">0</span>
                <span class="text-xs opacity-60">–æ—Å—Ç–∞–ª–æ—Å—å –∫–∫–∞–ª</span>
            </div>
        </div>

        <!-- –ü–æ–ª–æ—Å–∫–∏ –ë–ñ–£ -->
        <div class="grid grid-cols-3 gap-4 mt-2 text-center">
            <div>
                <div class="text-xs font-semibold mb-1">–ë–µ–ª–∫–∏</div>
                <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div id="barP" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
                </div>
                <div class="text-xs mt-1 opacity-70"><span id="valP">0</span> / <span id="goalP">0</span></div>
            </div>
            <div>
                <div class="text-xs font-semibold mb-1">–ñ–∏—Ä—ã</div>
                <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div id="barF" class="h-full bg-yellow-500 w-0 transition-all duration-500"></div>
                </div>
                <div class="text-xs mt-1 opacity-70"><span id="valF">0</span> / <span id="goalF">0</span></div>
            </div>
            <div>
                <div class="text-xs font-semibold mb-1">–£–≥–ª–µ–≤–æ–¥—ã</div>
                <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                    <div id="barC" class="h-full bg-green-500 w-0 transition-all duration-500"></div>
                </div>
                <div class="text-xs mt-1 opacity-70"><span id="valC">0</span> / <span id="goalC">0</span></div>
            </div>
        </div>
    </div>

    <!-- –°–ü–ò–°–û–ö –ü–†–ò–ï–ú–û–í –ü–ò–©–ò -->
    <div class="space-y-4 mb-20">
        <div id="mealsContainer"></div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø -->
    <div id="addModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 backdrop-blur-sm flex items-end sm:items-center justify-center transition-opacity">
        <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 transform transition-transform translate-y-0" style="background-color: var(--tg-theme-bg-color);">
            <h3 class="text-lg font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
            
            <div class="space-y-3">
                <select id="mealType" class="w-full p-3 rounded-lg border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 outline-none">
                    <option value="breakfast">–ó–∞–≤—Ç—Ä–∞–∫ ‚òïÔ∏è</option>
                    <option value="lunch">–û–±–µ–¥ üç≤</option>
                    <option value="snack">–ü–µ—Ä–µ–∫—É—Å üçè</option>
                    <option value="dinner">–£–∂–∏–Ω ü•ó</option>
                </select>
                
                <input type="text" id="foodName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –µ–¥—ã" class="w-full p-3 rounded-lg border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 outline-none">
                
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="inKcal" placeholder="–ö–∫–∞–ª" class="p-3 rounded-lg border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 outline-none">
                    <input type="number" id="inP" placeholder="–ë–µ–ª–∫–∏" class="p-3 rounded-lg border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 outline-none">
                    <input type="number" id="inF" placeholder="–ñ–∏—Ä—ã" class="p-3 rounded-lg border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 outline-none">
                    <input type="number" id="inC" placeholder="–£–≥–ª–µ–≤–æ–¥—ã" class="p-3 rounded-lg border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 outline-none">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-3 rounded-lg font-medium text-gray-500 bg-gray-200 dark:bg-gray-700">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveFood()" class="flex-1 py-3 rounded-lg font-medium btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ù–ê–°–¢–†–û–ï–ö (–ü–†–ò –ü–ï–†–í–û–ú –í–•–û–î–ï) -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-80 flex items-center justify-center">
        <div class="bg-white w-11/12 rounded-2xl p-6" style="background-color: var(--tg-theme-bg-color);">
            <h2 class="text-xl font-bold mb-2 text-center">–¢–≤–æ—è —Ü–µ–ª—å</h2>
            <p class="text-sm text-center mb-4 opacity-70">–£—Å—Ç–∞–Ω–æ–≤–∏ —Å–≤–æ–∏ —Å—É—Ç–æ—á–Ω—ã–µ –Ω–æ—Ä–º—ã</p>
            <div class="space-y-3">
                <input type="number" id="goalKcalInput" placeholder="–ù–æ—Ä–º–∞ –ö–∫–∞–ª (–Ω–∞–ø—Ä. 2000)" class="w-full p-3 rounded-lg border bg-gray-50 dark:bg-gray-800">
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" id="goalPInput" placeholder="–ë–µ–ª–∫–∏" class="p-2 rounded-lg border text-center bg-gray-50 dark:bg-gray-800">
                    <input type="number" id="goalFInput" placeholder="–ñ–∏—Ä—ã" class="p-2 rounded-lg border text-center bg-gray-50 dark:bg-gray-800">
                    <input type="number" id="goalCInput" placeholder="–£–≥–ª–µ" class="p-2 rounded-lg border text-center bg-gray-50 dark:bg-gray-800">
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full mt-6 py-3 rounded-lg font-bold btn-primary">–ù–∞—á–∞—Ç—å</button>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button onclick="openModal()" class="fixed bottom-6 right-6 w-14 h-14 rounded-full btn-primary shadow-lg flex items-center justify-center text-3xl font-light z-40">
        +
    </button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞—Å–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        // –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let goals = { kcal: 2000, p: 150, f: 60, c: 200 };
        let todayMeals = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Chart.js
        let chartInstance = null;
        
        function initChart() {
            const ctx = document.getElementById('caloriesChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–°—ä–µ–¥–µ–Ω–æ', '–û—Å—Ç–∞–ª–æ—Å—å'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [
                            getComputedStyle(document.documentElement).getPropertyValue('--tg-theme-button-color') || '#3b82f6', 
                            '#e5e7eb'
                        ],
                        borderWidth: 0,
                        cutout: '85%'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadData() {
            const savedGoals = localStorage.getItem('kbju_goals');
            const savedMeals = localStorage.getItem('kbju_meals_' + new Date().toDateString());

            if (savedGoals) goals = JSON.parse(savedGoals);
            else document.getElementById('settingsModal').classList.remove('hidden');

            if (savedMeals) todayMeals = JSON.parse(savedMeals);

            renderUI();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function renderUI() {
            // –ü–æ–¥—Å—á–µ—Ç —Å—É–º–º
            let total = { kcal: 0, p: 0, f: 0, c: 0 };
            todayMeals.forEach(m => {
                total.kcal += m.kcal;
                total.p += m.p;
                total.f += m.f;
                total.c += m.c;
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
            const remaining = Math.max(0, goals.kcal - total.kcal);
            chartInstance.data.datasets[0].data = [total.kcal, remaining];
            chartInstance.update();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –∏ –ø–æ–ª–æ—Å–æ–∫
            document.getElementById('calLeft').innerText = remaining;
            
            updateBar('P', total.p, goals.p);
            updateBar('F', total.f, goals.f);
            updateBar('C', total.c, goals.c);

            // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –µ–¥—ã
            renderMealsList();
        }

        function updateBar(type, val, goal) {
            document.getElementById(`val${type}`).innerText = val;
            document.getElementById(`goal${type}`).innerText = goal;
            const pct = Math.min(100, (val / goal) * 100);
            document.getElementById(`bar${type}`).style.width = `${pct}%`;
        }

        function renderMealsList() {
            const container = document.getElementById('mealsContainer');
            container.innerHTML = '';
            
            const categories = {
                'breakfast': '–ó–∞–≤—Ç—Ä–∞–∫ ‚òïÔ∏è',
                'lunch': '–û–±–µ–¥ üç≤',
                'snack': '–ü–µ—Ä–µ–∫—É—Å üçè',
                'dinner': '–£–∂–∏–Ω ü•ó'
            };

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
            for (let [key, label] of Object.entries(categories)) {
                const mealsInCat = todayMeals.filter(m => m.type === key);
                if (mealsInCat.length === 0) continue;

                let html = `<div class="card p-4"><h3 class="font-bold mb-3 text-sm opacity-60 uppercase tracking-wide">${label}</h3>`;
                
                mealsInCat.forEach((meal, index) => {
                    // –ù–∞–π–¥–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                    const globalIndex = todayMeals.indexOf(meal);
                    html += `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-800 last:border-0">
                            <div>
                                <div class="font-medium">${meal.name}</div>
                                <div class="text-xs opacity-60">${meal.kcal} –∫–∫–∞–ª ‚Ä¢ –ë:${meal.p} –ñ:${meal.f} –£:${meal.c}</div>
                            </div>
                            <button onclick="deleteMeal(${globalIndex})" class="text-red-400 px-2">‚úï</button>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML += html;
            }
        }

        // –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª–æ–∫
        function openModal() {
            document.getElementById('addModal').classList.remove('hidden');
            tg.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ–¥—É");
            tg.MainButton.show();
            tg.MainButton.onClick(saveFood); // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        }

        function closeModal() {
            document.getElementById('addModal').classList.add('hidden');
            tg.MainButton.hide();
            tg.MainButton.offClick(saveFood);
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('foodName').value = '';
            document.getElementById('inKcal').value = '';
            document.getElementById('inP').value = '';
            document.getElementById('inF').value = '';
            document.getElementById('inC').value = '';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –µ–¥—ã
        function saveFood() {
            const name = document.getElementById('foodName').value;
            const kcal = Number(document.getElementById('inKcal').value);
            
            if(!name || !kcal) {
                tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞–ª–æ—Ä–∏–∏!");
                return;
            }

            const newItem = {
                type: document.getElementById('mealType').value,
                name: name,
                kcal: kcal,
                p: Number(document.getElementById('inP').value) || 0,
                f: Number(document.getElementById('inF').value) || 0,
                c: Number(document.getElementById('inC').value) || 0
            };

            todayMeals.push(newItem);
            localStorage.setItem('kbju_meals_' + new Date().toDateString(), JSON.stringify(todayMeals));
            
            closeModal();
            renderUI();
            
            // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–∏—è—Ç–Ω–æ–≥–æ —Ñ–∏–¥–±–µ–∫–∞
            tg.HapticFeedback.notificationOccurred('success');
        }

        function deleteMeal(index) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                todayMeals.splice(index, 1);
                localStorage.setItem('kbju_meals_' + new Date().toDateString(), JSON.stringify(todayMeals));
                renderUI();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function saveSettings() {
            const k = document.getElementById('goalKcalInput').value;
            if(!k) return;

            goals = {
                kcal: Number(k),
                p: Number(document.getElementById('goalPInput').value) || 100,
                f: Number(document.getElementById('goalFInput').value) || 60,
                c: Number(document.getElementById('goalCInput').value) || 200
            };
            localStorage.setItem('kbju_goals', JSON.stringify(goals));
            document.getElementById('settingsModal').classList.add('hidden');
            renderUI();
        }

        // –°—Ç–∞—Ä—Ç
        initChart();
        loadData();

    </script>
</body>
</html>