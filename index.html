<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KBJU Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { 
            background-color: #f5f5f5; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            -webkit-user-select: none; 
            user-select: none; 
        }
        /* –õ–æ–∞–¥–µ—Ä */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* –ö–æ–Ω—Å–æ–ª—å –æ—à–∏–±–æ–∫ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        #error-console { display: none; background: #000; color: #ff4444; padding: 10px; font-size: 10px; margin-bottom: 10px; border-radius: 8px; font-family: monospace; }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±–µ–∑ —Ä–∞–º–æ–∫ */
        input[type="date"] {
            background: transparent;
            font-size: 1.1rem;
            font-weight: bold;
            color: #374151;
            border: none;
            outline: none;
            font-family: inherit;
        }
    </style>
</head>
<body class="p-4 pb-24">

    <!-- üî¥ –ö–û–ù–°–û–õ–¨ –û–®–ò–ë–û–ö -->
    <div id="error-console">ERRORS:<br></div>

    <!-- ‚è≥ –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button onclick="forceStart()" class="mt-8 text-blue-500 text-xs underline opacity-60">–î–æ–ª–≥–æ –≥—Ä—É–∑–∏—Ç? –ù–∞–∂–º–∏ —Å—é–¥–∞</button>
    </div>

    <!-- üì± –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù -->
    <div id="main-app" class="hidden">
        
        <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨: –î–ê–¢–ê –ò –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-xl shadow-sm">
            <div class="flex items-center gap-2">
                <span class="text-xl">üìÖ</span>
                <input type="date" id="datePicker" onchange="changeDate()">
            </div>
            <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
            <button onclick="openSettings()" class="p-2 text-gray-400 hover:text-blue-500 active:scale-90 transition-transform">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
        </div>

        <!-- –ö–†–£–ì –ò –ü–û–õ–û–°–ö–ò -->
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-6 relative">
            <div class="relative h-40 flex justify-center mb-4">
                <canvas id="caloriesChart"></canvas>
                <div class="absolute inset-0 flex items-center justify-center flex-col pt-4">
                    <span id="calLeft" class="text-3xl font-bold">0</span>
                    <span class="text-xs text-gray-400 uppercase">–∫–∫–∞–ª –æ—Å—Ç.</span>
                </div>
            </div>
            <!-- –ü–æ–ª–æ—Å–∫–∏ –ë–ñ–£ -->
            <div class="grid grid-cols-3 gap-2 text-center text-xs">
                <div>
                    <div class="font-bold text-gray-500 mb-1">–ë–ï–õ–ö–ò</div>
                    <div class="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden"><div id="barP" class="h-full bg-blue-500 w-0"></div></div>
                    <div class="mt-1"><span id="valP">0</span>/<span id="goalP">0</span></div>
                </div>
                <div>
                    <div class="font-bold text-gray-500 mb-1">–ñ–ò–†–´</div>
                    <div class="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden"><div id="barF" class="h-full bg-yellow-500 w-0"></div></div>
                    <div class="mt-1"><span id="valF">0</span>/<span id="goalF">0</span></div>
                </div>
                <div>
                    <div class="font-bold text-gray-500 mb-1">–£–ì–õ–ò</div>
                    <div class="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden"><div id="barC" class="h-full bg-green-500 w-0"></div></div>
                    <div class="mt-1"><span id="valC">0</span>/<span id="goalC">0</span></div>
                </div>
            </div>
        </div>

        <!-- –°–ü–ò–°–û–ö –ï–î–´ -->
        <div id="mealsList" class="space-y-3 pb-10"></div>
        <div id="emptyMsg" class="text-center text-gray-400 text-sm mt-4 hidden">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç üçÉ</div>

        <!-- –ö–ù–û–ü–ö–ê + -->
        <button onclick="openAddModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-500 text-white rounded-full shadow-lg flex items-center justify-center text-3xl font-light active:scale-90 transition-transform">+</button>
    </div>

    <!-- üü¶ –ú–û–î–ê–õ–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ï–î–´ -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
            
            <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ -->
            <div class="flex gap-2 overflow-x-auto pb-3 mb-2 no-scrollbar">
                <button onclick="fill('–Ø–±–ª–æ–∫–æ',52,0,0,14)" class="px-3 py-2 bg-gray-100 rounded-lg text-xs whitespace-nowrap active:bg-blue-100">üçé –Ø–±–ª–æ–∫–æ</button>
                <button onclick="fill('–ë–∞–Ω–∞–Ω',96,1,0,21)" class="px-3 py-2 bg-gray-100 rounded-lg text-xs whitespace-nowrap active:bg-blue-100">üçå –ë–∞–Ω–∞–Ω</button>
                <button onclick="fill('–ö–æ—Ñ–µ',40,2,2,4)" class="px-3 py-2 bg-gray-100 rounded-lg text-xs whitespace-nowrap active:bg-blue-100">‚òïÔ∏è –ö–æ—Ñ–µ</button>
                <button onclick="fill('–Ø–π—Ü–æ',70,6,5,0)" class="px-3 py-2 bg-gray-100 rounded-lg text-xs whitespace-nowrap active:bg-blue-100">ü•ö –Ø–π—Ü–æ</button>
                <button onclick="fill('–ö—É—Ä–∏—Ü–∞',165,31,3,0)" class="px-3 py-2 bg-gray-100 rounded-lg text-xs whitespace-nowrap active:bg-blue-100">üçó –ö—É—Ä–∏—Ü–∞</button>
            </div>

            <input type="text" id="mName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ë–æ—Ä—â)" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none font-medium">
            <div class="flex gap-3 mb-5">
                <div class="w-1/2">
                    <label class="text-[10px] text-gray-400 uppercase font-bold ml-1">–ö–∫–∞–ª</label>
                    <input type="number" id="mKcal" class="w-full p-3 bg-gray-100 rounded-xl text-center font-bold outline-none text-lg">
                </div>
                <!-- –ú–æ–∂–Ω–æ —Ä–∞—Å–∫—Ä—ã—Ç—å –ë–ñ–£ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –ø–æ–∫–∞ —Å–∫—Ä—ã—Ç—ã –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã -->
                <input type="hidden" id="mP" value="0"><input type="hidden" id="mF" value="0"><input type="hidden" id="mC" value="0">
            </div>
            
            <button onclick="addItem()" class="w-full py-3.5 bg-blue-500 text-white rounded-xl font-bold text-lg shadow-lg shadow-blue-500/30 active:scale-95 transition-transform">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeModal()" class="w-full py-3 text-gray-400 mt-2 font-medium">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- ‚öôÔ∏è –ú–û–î–ê–õ–ö–ê –ù–ê–°–¢–†–û–ï–ö (–¶–ï–õ–ò) -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 text-center shadow-2xl">
            <h2 class="text-2xl font-bold mb-2">üéØ –¢–≤–æ—è —Ü–µ–ª—å</h2>
            <p class="text-sm text-gray-400 mb-6">–£—Å—Ç–∞–Ω–æ–≤–∏ —Å—É—Ç–æ—á–Ω—ã–µ –Ω–æ—Ä–º—ã</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold uppercase text-gray-400 ml-1">–ö–∞–ª–æ—Ä–∏–∏</label>
                    <input type="number" id="setKcal" placeholder="2000" class="w-full mt-1 p-3 rounded-xl bg-gray-100 text-xl font-bold outline-none">
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-400 ml-1">–ë–µ–ª–∫–∏</label>
                        <input type="number" id="setP" placeholder="150" class="w-full mt-1 p-2 rounded-xl bg-blue-50 text-center outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-400 ml-1">–ñ–∏—Ä—ã</label>
                        <input type="number" id="setF" placeholder="60" class="w-full mt-1 p-2 rounded-xl bg-yellow-50 text-center outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold uppercase text-gray-400 ml-1">–£–≥–ª–∏</label>
                        <input type="number" id="setC" placeholder="200" class="w-full mt-1 p-2 rounded-xl bg-green-50 text-center outline-none">
                    </div>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="w-full mt-8 py-3.5 rounded-xl font-bold text-lg bg-blue-500 text-white shadow-lg shadow-blue-500/30 active:scale-95 transition-transform">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </div>
    </div>

    <script>
        // --- 1. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –û–®–ò–ë–û–ö (–ß–¢–û–ë–´ –í–ò–î–ï–¢–¨ –ù–ê –¢–ï–õ–ï–§–û–ù–ï) ---
        const errConsole = document.getElementById('error-console');
        function logError(msg) {
            errConsole.style.display = 'block';
            errConsole.innerHTML += "üî¥ " + msg + "<br>";
            console.error(msg);
        }
        window.onerror = function(msg, url, line) { logError(msg + " (line " + line + ")"); };

        // --- 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ---
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let data = {
            goals: { k: 2000, p: 150, f: 60, c: 200 },
            meals: []
        };
        let chart = null;

        // --- 3. –†–ê–ë–û–¢–ê –° –î–ê–¢–û–ô ---
        function getSelectedDateKey() {
            const pickerValue = document.getElementById('datePicker').value;
            if (!pickerValue) {
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `kbju_meals_${y}-${m}-${day}`;
            }
            return `kbju_meals_${pickerValue}`;
        }

        function setTodayInPicker() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            document.getElementById('datePicker').value = `${y}-${m}-${day}`;
        }

        // --- 4. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---
        async function loadAllData() {
            try {
                // 1. –ì—Ä—É–∑–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ü–µ–ª–∏)
                const savedGoals = localStorage.getItem('kbju_goals');
                if (savedGoals) {
                    data.goals = JSON.parse(savedGoals);
                } else {
                    // –ï—Å–ª–∏ —Ü–µ–ª–µ–π –Ω–µ—Ç –≤–æ–æ–±—â–µ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                    setTimeout(() => openSettings(), 500);
                }

                // 2. –ì—Ä—É–∑–∏–º –µ–¥—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
                await loadMealsForDate();
                
            } catch (e) {
                logError("Init error: " + e.message);
            } finally {
                // –£–±–∏—Ä–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
            }
        }

        async function loadMealsForDate() {
            const list = document.getElementById('mealsList');
            list.style.opacity = '0.5'; // –≠—Ñ—Ñ–µ–∫—Ç –∑–∞–≥—Ä—É–∑–∫–∏
            
            const key = getSelectedDateKey();
            data.meals = []; // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

            // A. –°–Ω–∞—á–∞–ª–∞ LocalStorage (–±—ã—Å—Ç—Ä–æ)
            const localRaw = localStorage.getItem(key);
            if (localRaw) {
                data.meals = JSON.parse(localRaw);
            }
            render(); 

            // B. –ü–æ—Ç–æ–º –û–±–ª–∞–∫–æ (—Ñ–æ–Ω–æ–º)
            tg.CloudStorage.getItem(key, (err, val) => {
                list.style.opacity = '1';
                if (!err && val) {
                    data.meals = JSON.parse(val);
                    render(); // –û–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ –≤ –æ–±–ª–∞–∫–µ –Ω–æ–≤–µ–µ
                } else {
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ–±–ª–∞–∫–∞, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    list.style.opacity = '1';
                }
            });
        }

        function changeDate() {
            loadMealsForDate();
        }

        // --- 5. –°–û–•–†–ê–ù–ï–ù–ò–ï ---
        function saveMeals() {
            const key = getSelectedDateKey();
            const json = JSON.stringify(data.meals);
            localStorage.setItem(key, json); // –¢–µ–ª–µ—Ñ–æ–Ω
            tg.CloudStorage.setItem(key, json); // –û–±–ª–∞–∫–æ
            render();
        }

        function saveSettings() {
            const k = document.getElementById('setKcal').value;
            if(!k) { tg.showAlert("–í–≤–µ–¥–∏ –∫–∞–ª–æ—Ä–∏–∏!"); return; }

            data.goals = {
                k: Number(k),
                p: Number(document.getElementById('setP').value) || 150,
                f: Number(document.getElementById('setF').value) || 60,
                c: Number(document.getElementById('setC').value) || 200
            };

            const json = JSON.stringify(data.goals);
            localStorage.setItem('kbju_goals', json);
            tg.CloudStorage.setItem('kbju_goals', json);

            document.getElementById('settingsModal').classList.add('hidden');
            render();
            tg.HapticFeedback.notificationOccurred('success');
        }

        // --- 6. –û–¢–†–ò–°–û–í–ö–ê ---
        function render() {
            // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—ã
            let totals = { k:0, p:0, f:0, c:0 };
            data.meals.forEach(m => {
                totals.k += m.k; totals.p += m.p; totals.f += m.f; totals.c += m.c;
            });

            const left = data.goals.k - totals.k;
            document.getElementById('calLeft').innerText = left > 0 ? left : 0;
            
            updateBar('P', totals.p, data.goals.p);
            updateBar('F', totals.f, data.goals.f);
            updateBar('C', totals.c, data.goals.c);

            // –°–ø–∏—Å–æ–∫ –µ–¥—ã
            const list = document.getElementById('mealsList');
            const emptyMsg = document.getElementById('emptyMsg');
            list.innerHTML = '';

            if (data.meals.length === 0) {
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                data.meals.forEach((m, idx) => {
                    list.innerHTML += `
                        <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-b border-gray-50 last:border-0">
                            <div>
                                <div class="font-bold text-sm">${m.name}</div>
                                <div class="text-xs text-gray-500">${m.k} –∫–∫–∞–ª</div>
                            </div>
                            <button onclick="removeMeal(${idx})" class="text-red-400 font-bold px-3 py-2 active:scale-90 transition-transform">‚úï</button>
                        </div>
                    `;
                });
            }

            updateChart(totals.k, left > 0 ? left : 0);
        }

        function updateBar(type, val, max) {
            const pct = Math.min(100, (val/max)*100);
            document.getElementById(`val${type}`).innerText = val;
            document.getElementById(`goal${type}`).innerText = max;
            const bar = document.getElementById(`bar${type}`);
            bar.style.width = pct + "%";
            if(val > max) bar.classList.add('bg-red-500'); 
            else bar.classList.remove('bg-red-500');
        }

        function updateChart(eaten, left) {
            const ctx = document.getElementById('caloriesChart');
            if(!ctx) return;
            const color = eaten > data.goals.k ? '#ef4444' : '#3b82f6';

            if(chart) {
                chart.data.datasets[0].data = [eaten, left];
                chart.data.datasets[0].backgroundColor[0] = color;
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['–ï–¥–∞', '–û—Å—Ç.'],
                        datasets: [{ 
                            data: [eaten, left], 
                            backgroundColor: [color, '#f3f4f6'], 
                            borderWidth: 0, 
                            borderRadius: 20,
                            cutout: '85%' 
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, animation: { duration: 500 } }
                });
            }
        }

        // --- 7. UI –§–£–ù–ö–¶–ò–ò ---
        function openAddModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        
        function openSettings() {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω–ø—É—Ç—ã —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            document.getElementById('setKcal').value = data.goals.k;
            document.getElementById('setP').value = data.goals.p;
            document.getElementById('setF').value = data.goals.f;
            document.getElementById('setC').value = data.goals.c;
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function fill(n,k,p,f,c) {
            document.getElementById('mName').value = n;
            document.getElementById('mKcal').value = k;
            document.getElementById('mP').value = p;
            document.getElementById('mF').value = f;
            document.getElementById('mC').value = c;
        }

        function addItem() {
            const name = document.getElementById('mName').value;
            const k = Number(document.getElementById('mKcal').value);
            if(!name || !k) { tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∫–∞–ª"); return; }

            data.meals.push({
                name: name, k: k,
                p: Number(document.getElementById('mP').value)||0,
                f: Number(document.getElementById('mF').value)||0,
                c: Number(document.getElementById('mC').value)||0
            });
            saveMeals();
            closeModal();
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('mName').value = '';
            document.getElementById('mKcal').value = '';
        }

        function removeMeal(idx) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                data.meals.splice(idx, 1);
                saveMeals();
            }
        }

        function forceStart() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            setTodayInPicker();
            loadAllData();
        }

        // –ó–ê–ü–£–°–ö
        window.onload = function() {
            setTodayInPicker();
            loadAllData();
        };

    </script>
</body>
</html>
